<!DOCTYPE html>
<html>
<head>
  <title>AI Remodeling Consultation</title>
  <style>
    body { font-family: Arial; background:#f5f3ef; padding:40px; }
    .chat { max-width:600px; margin:auto; background:white; padding:20px; border-radius:8px; height:500px; overflow-y:auto; }
    .message { margin-bottom:15px; }
    .user { text-align:right; color:#2e3d34; }
    .ai { text-align:left; color:#333; }
    input { width:100%; padding:10px; margin-top:10px; }
    button { width:100%; padding:10px; margin-top:10px; background:#2e3d34; color:white; border:none; }
  </style>
</head>
<body>

<h2>AI Project Consultation</h2>

<div class="chat" id="chat"></div>
<input id="input" placeholder="Type your answer..." />
<button onclick="sendMessage()">Send</button>

<script>
const urlParams = new URLSearchParams(window.location.search);
const contractorId = urlParams.get("contractorId");

let messages = [];

function addMessage(text, type) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "message " + type;
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value;
  if (!text) return;

  addMessage(text, "user");
  messages.push({ role: "user", content: text });
  input.value = "";

  const response = await fetch("/ai-intake", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ messages })
  });

  const data = await response.json();
  const reply = data.reply;

  if (reply.startsWith("FINAL_JSON:")) {
    const jsonText = reply.replace("FINAL_JSON:", "").trim();
    const structured = JSON.parse(jsonText);

   await fetch("/complete", {
  method: "POST",
  headers: {"Content-Type":"application/json"},
  body: JSON.stringify({
    projectType: structured.projectType,
    budget: structured.budgetRange,
    timeline: structured.timeline,
    zip: structured.zipCode,
    name: structured.fullName,
    email: structured.email,
    phone: structured.phoneNumber,
    contractorId
  })
});


    addMessage("Thank you! A contractor will reach out shortly.", "ai");
    return;
  }

  addMessage(reply, "ai");
  messages.push({ role: "assistant", content: reply });
}

addMessage("Hi! What kind of project are you planning?", "ai");
messages.push({ role: "assistant", content: "Hi! What kind of project are you planning?" });
</script>

</body>
</html>
